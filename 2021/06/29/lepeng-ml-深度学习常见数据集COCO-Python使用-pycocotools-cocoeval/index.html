<!DOCTYPE html>
<html lang="en">

<!-- Head tag -->
<head>
    <meta charset="utf-8">
    <meta http-equiv="X-UA-Compatible" content="IE=edge">
    <script data-ad-client="ca-pub-2488174175014870" async src="https://pagead2.googlesyndication.com/pagead/js/adsbygoogle.js"></script> <!-- google ad -->
    <meta name="google-site-verification" content="40lMg4eqLLbXoDcpN3h-cEnfmselbQ8tUzNvuC0IRIs" /><!-- google 站点认证 -->
    <meta name="baidu-site-verification" content="093lY4ziMu" />
    <meta name="viewport" content="width=device-width, initial-scale=1, user-scalable=no">
    <meta name="description" content="A hexo theme">
    <meta name="keyword"  content="hexo, hexo-theme-lp">
    <link rel="shortcut icon" href="/img/ironman-draw.png">
    <!-- Place this tag in your head or just before your close body tag. -->
    <script async defer src="https://buttons.github.io/buttons.js"></script>
    <!--<link href='http://fonts.googleapis.com/css?family=Montserrat:400,700' rel='stylesheet' type='text/css'>-->
    <title>
        
          深度学习常见数据集COCO Python 使用 pycocotools.cocoeval - Hexo-theme-lp
        
    </title>

    <link rel="canonical" href="https://flepeng.github.io/2021/06/29/lepeng-ml-深度学习常见数据集COCO-Python使用-pycocotools-cocoeval/">

    <!-- Bootstrap Core CSS -->
    
<link rel="stylesheet" href="/css/bootstrap.min.css">


    <!-- Custom CSS --> 
    
        
<link rel="stylesheet" href="/css/dusign-light.css">

        
<link rel="stylesheet" href="/css/dusign-common-light.css">

        
<link rel="stylesheet" href="/css/font-awesome.css">

        
<link rel="stylesheet" href="/css/toc.css">

        <!-- background effects end -->
    
    
    <!-- Pygments Highlight CSS -->
    
<link rel="stylesheet" href="/css/highlight.css">


    
<link rel="stylesheet" href="/css/widget.css">


    
<link rel="stylesheet" href="/css/rocket.css">


    
<link rel="stylesheet" href="/css/signature.css">


    
<link rel="stylesheet" href="/css/fonts.googleapis.css">


    <link rel="stylesheet" href="//cdn.bootcss.com/font-awesome/4.3.0/css/font-awesome.min.css">

    <!-- photography -->
    
<link rel="stylesheet" href="/css/photography.css">


    <!-- ga & ba script hoook -->
    <script></script>
<meta name="generator" content="Hexo 4.2.1"></head>


<!-- hack iOS CSS :active style -->
<body ontouchstart="">

    <!-- background effects start -->
    
    <!-- background effects end -->

	<!-- Post Header -->
<style type="text/css">
    header.intro-header{
        
            
                background-image: linear-gradient(rgba(0, 0, 0, 0.3), rgba(0, 0, 0, 0.3)), url('/img/header_img/archive-bg.jpg')
                /*post*/
            
        
    }
    
    #signature{
        background-image: url('/img/signature/dusign.png');
    }
    
</style>

<header class="intro-header" >
    <!-- Signature -->
    <div id="signature">
        <div class="container">
            <div class="row">
                <div class="col-lg-8 col-lg-offset-2 col-md-10 col-md-offset-1">
                
                    <div class="post-heading">
                        <div class="tags">
                            
                              <a class="tag" href="/tags/#Python" title="Python">Python</a>
                            
                              <a class="tag" href="/tags/#深度学习" title="深度学习">深度学习</a>
                            
                        </div>
                        <h1>深度学习常见数据集COCO Python 使用 pycocotools.cocoeval</h1>
                        <h2 class="subheading"></h2>
                        <span class="meta">
                            Posted by Lepeng on
                            2021-06-29
                        </span>

                        
                            <div class="blank_box"></div>
                            <span class="meta">
                                Words <span class="post-count">6.6k</span> and
                                Reading Time <span class="post-count">34</span> Minutes
                            </span>
                            <div class="blank_box"></div>
                            <!-- 不蒜子统计 start -->
                            <span class="meta">
                                Viewed <span id="busuanzi_value_page_pv"><i class="fa fa-spinner fa-spin"></i></span> Times
                            </span>
                            <!-- 不蒜子统计 end -->
                        

                    </div>
                

                </div>
            </div>
        </div>      
    </div>

    
    <div class="waveWrapper">
        <div class="wave wave_before" style="background-image: url('/img/wave-light.png')"></div>
        <div class="wave wave_after" style="background-image: url('/img/wave-light.png')"></div>
    </div>
    
</header>

	
    <!-- Navigation -->
<nav class="navbar navbar-default navbar-custom navbar-fixed-top">
    <div class="container-fluid">
        <!-- Brand and toggle get grouped for better mobile display -->
        <div class="navbar-header page-scroll">
            <button type="button" class="navbar-toggle">
                <span class="sr-only">Toggle navigation</span>
                <span class="icon-bar"></span>
                <span class="icon-bar"></span>
                <span class="icon-bar"></span>
            </button>
            <a class="navbar-brand" href="/">Lepeng</a>
        </div>

        <!-- Collect the nav links, forms, and other content for toggling -->
        <!-- Known Issue, found by Hux:
            <nav>'s height woule be hold on by its content.
            so, when navbar scale out, the <nav> will cover tags.
            also mask any touch event of tags, unfortunately.
        -->
        <div id="huxblog_navbar">
            <div class="navbar-collapse">
                <ul class="nav navbar-nav navbar-right">
                    <li>
                        <a href="/">Home</a>
                    </li>

                    

                        
                    

                        
                    

                        
                        <li>
                            <a href="/about/">About</a>
                        </li>
                        
                    

                        
                        <li>
                            <a href="/archive/">Archives</a>
                        </li>
                        
                    

                        
                        <li>
                            <a href="/categories/">Categories</a>
                        </li>
                        
                    

                        
                        <li>
                            <a href="/tags/">Tags</a>
                        </li>
                        
                    
                    
                    
                    <li>
                        <a href="http://flepeng.com" target="_blank">chinese_blog</a>
                    </li>
                    
                </ul>
            </div>
        </div>
        <!-- /.navbar-collapse -->
    </div>
    <!-- /.container -->
</nav>
<script>
    // Drop Bootstarp low-performance Navbar
    // Use customize navbar with high-quality material design animation
    // in high-perf jank-free CSS3 implementation
    var $body   = document.body;
    var $toggle = document.querySelector('.navbar-toggle');
    var $navbar = document.querySelector('#huxblog_navbar');
    var $collapse = document.querySelector('.navbar-collapse');

    $toggle.addEventListener('click', handleMagic)
    function handleMagic(e){
        if ($navbar.className.indexOf('in') > 0) {
        // CLOSE
            $navbar.className = " ";
            // wait until animation end.
            setTimeout(function(){
                // prevent frequently toggle
                if($navbar.className.indexOf('in') < 0) {
                    $collapse.style.height = "0px"
                }
            },400)
        }else{
        // OPEN
            $collapse.style.height = "auto"
            $navbar.className += " in";
        }
    }
</script>


    <!-- Main Content -->
    <!-- Post Content -->
<article>
    <div class="container">
        <div class="row">

            <!-- Post Container -->
            <div class="
                col-lg-8 col-lg-offset-2
                col-md-10 col-md-offset-1
                post-container">

                <p>首先了解下cocoeval .py的构成吧。</p>
<h3 id="Params类："><a href="#Params类：" class="headerlink" title="Params类："></a>Params类：</h3><p>对于COCO格式的数据检测，我们主要分为不同的IoU阈值，不同的面积范围，单张图片的最大检测数量。在这些不同的参数下，会得到不同的AP与AR。</p>
<p>所以在这个类中，我们需要指定这些参数的数值范围，具体可看下面贴出的代码。</p>
<p>标准的即IoU阈值设置为从0.5-0.95 间隔0.05，一共10个阈值</p>
<p>AR的阈值为0-1 间隔0.01 ，一共101个阈值</p>
<p>面积范围为 small(0~32) medium(32~96) large(96~10**5)</p>
<p>检测最大数，按照置信度分数排序后选择最大检测数范围内的det结果。</p>
<h3 id="COCOeval类："><a href="#COCOeval类：" class="headerlink" title="COCOeval类："></a>COCOeval类：</h3><p>创建COCOeval这个类的时候，我们需要传入两个COCO 类别的instance，</p>
<ul>
<li>一个是gt对应的COCO</li>
<li>一个是det对应的COCO</li>
</ul>
<p>OK，COCOeval类有三个方法是我们在det中会用到的，分别为evaluate，accumulate，summarize</p>
<ul>
<li><p>evaluate的作用就是得到单张图片在特定类别，特定面积阈值内，特定最大检测数下的所有阈值检测结果。</p>
</li>
<li><p>accumulate是对这些单张图片的结果进行积累计算。</p>
</li>
<li><p>summarize会根据传入IoU阈值、面积阈值、最大检测数这些参数返回对应的mAp与mAR。</p>
</li>
</ul>
<h3 id="一个整体的流程："><a href="#一个整体的流程：" class="headerlink" title="一个整体的流程："></a>一个整体的流程：</h3><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line">首先我们创建COCOeval类，传入gt和det对应的两个COCO类，COCOeval类的构造函数会把gt中对应的img id与 cat id添加至类变量中。</span><br><span class="line"></span><br><span class="line">然后我们调用这个instance的evaluate方法，在这个方法里调用_prepare方法，会生成gt与dt的字典列表，用[img_id,cat_id]作为key，value即为这个指定图片指定类别对应的所有ann信息，是一个list形式。根据这两个字典列表，我们可以生成iou计算，iou计算也以[img_id,cat_id]作为key，value是一个M*N维的ndarry矩阵，m为dt的个数，n为gt的个数。</span><br><span class="line"></span><br><span class="line">然后将会调用evaluateImg这个方法，这个方法传入固定的img_id,cat_id,aRng,maxDet,我们可以得到对应的img在特定类别，特定面积阈值，特定最大检测数下的检测结果，（对于面积阈值来说，如果ann对应的bbox超过了就设置为ignore，对于最大检测数，按照置信度排序后取出前最大检测数个即可）把这个检测结果按照K，A，M的顺序堆叠，可以得到self.evalImgs这个list，这个list包含了所有图片在所有IoU阈值，面积阈值，最大检测数下的所有检测结果。</span><br><span class="line"></span><br><span class="line">继续调用instance的accumulate方法，可以根据上述得到的self.evalImgs返回所有图片在不同IoU阈值、不同AR、不同类别、不同面积阈值、不同最大检测数下的Ap与AR，以numpy数组的返回，即precision(T,R,K,A,M) recall(T,K,A,M)。</span><br><span class="line"></span><br><span class="line">继续调用instance的summarize方法，会根据传入的具体的IoU阈值，面积阈值，最大检测数的值返回上述precision和recall中对应维的检测结果，我们就可以自定义形式返回我们想要的各种参数下的AP与AR啦。</span><br><span class="line"></span><br><span class="line">上面说的可能比较简单而且隐晦，下面贴注释过的源码，建议跟着上面说的顺序看一下以便理解。</span><br></pre></td></tr></table></figure>
<h2 id="调用"><a href="#调用" class="headerlink" title="调用"></a>调用</h2><h3 id="方式一，计算map"><a href="#方式一，计算map" class="headerlink" title="方式一，计算map"></a>方式一，计算map</h3><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"># running evaluation</span><br><span class="line">cocoEval &#x3D; COCOeval(cocoGt,cocoDt,annType)</span><br><span class="line">cocoEval.evaluate()</span><br><span class="line">cocoEval.accumulate()</span><br><span class="line">cocoEval.summarize()</span><br></pre></td></tr></table></figure>
<h3 id="方式一，计算-precision"><a href="#方式一，计算-precision" class="headerlink" title="方式一，计算 precision"></a>方式一，计算 precision</h3><p>coco_eval.eval[‘precision’]是一个5维的数组。</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line">self.eval &#x3D; &#123;</span><br><span class="line">    &#39;params&#39;: p,</span><br><span class="line">    &#39;counts&#39;: [T, R, K, A, M],</span><br><span class="line">    &#39;date&#39;: datetime.datetime.now().strftime(&#39;%Y-%m-%d %H:%M:%S&#39;),</span><br><span class="line">    &#39;precision&#39;: precision,</span><br><span class="line">    &#39;recall&#39;:   recall,</span><br><span class="line">    &#39;scores&#39;: scores,</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line">T           &#x3D; len(p.iouThrs)</span><br><span class="line">R           &#x3D; len(p.recThrs)</span><br><span class="line">K           &#x3D; len(p.catIds) if p.useCats else 1</span><br><span class="line">A           &#x3D; len(p.areaRng)</span><br><span class="line">M           &#x3D; len(p.maxDets)</span><br><span class="line">precision   &#x3D; -np.ones((T,R,K,A,M)) # -1 for the precision of absent categories</span><br><span class="line">recall      &#x3D; -np.ones((T,K,A,M))</span><br><span class="line">scores      &#x3D; -np.ones((T,R,K,A,M))</span><br></pre></td></tr></table></figure>
<p>precision 五维：</p>
<ul>
<li>第一维T：IoU的10个阈值，从0.5到0.95间隔0.05。</li>
<li>第二维R：101个recall 阈值，从0到101</li>
<li>第三维K：类别，如果是想展示第一类的结果就设为0</li>
<li>第四维A：area 目标的大小范围 （all，small, medium, large）</li>
<li>第五维M：maxDets 单张图像中最多检测框的数量 三种 1,10,100</li>
</ul>
<p>所以, coco_eval.eval[‘precision’][0, :, 0, 0, 2] 所表示的就是当IoU=0.5时，从0到100的101个recall对应的101个precision的值。</p>
<h3 id="源码加注释"><a href="#源码加注释" class="headerlink" title="源码加注释"></a>源码加注释</h3><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br><span class="line">116</span><br><span class="line">117</span><br><span class="line">118</span><br><span class="line">119</span><br><span class="line">120</span><br><span class="line">121</span><br><span class="line">122</span><br><span class="line">123</span><br><span class="line">124</span><br><span class="line">125</span><br><span class="line">126</span><br><span class="line">127</span><br><span class="line">128</span><br><span class="line">129</span><br><span class="line">130</span><br><span class="line">131</span><br><span class="line">132</span><br><span class="line">133</span><br><span class="line">134</span><br><span class="line">135</span><br><span class="line">136</span><br><span class="line">137</span><br><span class="line">138</span><br><span class="line">139</span><br><span class="line">140</span><br><span class="line">141</span><br><span class="line">142</span><br><span class="line">143</span><br><span class="line">144</span><br><span class="line">145</span><br><span class="line">146</span><br><span class="line">147</span><br><span class="line">148</span><br><span class="line">149</span><br><span class="line">150</span><br><span class="line">151</span><br><span class="line">152</span><br><span class="line">153</span><br><span class="line">154</span><br><span class="line">155</span><br><span class="line">156</span><br><span class="line">157</span><br><span class="line">158</span><br><span class="line">159</span><br><span class="line">160</span><br><span class="line">161</span><br><span class="line">162</span><br><span class="line">163</span><br><span class="line">164</span><br><span class="line">165</span><br><span class="line">166</span><br><span class="line">167</span><br><span class="line">168</span><br><span class="line">169</span><br><span class="line">170</span><br><span class="line">171</span><br><span class="line">172</span><br><span class="line">173</span><br><span class="line">174</span><br><span class="line">175</span><br><span class="line">176</span><br><span class="line">177</span><br><span class="line">178</span><br><span class="line">179</span><br><span class="line">180</span><br><span class="line">181</span><br><span class="line">182</span><br><span class="line">183</span><br><span class="line">184</span><br><span class="line">185</span><br><span class="line">186</span><br><span class="line">187</span><br><span class="line">188</span><br><span class="line">189</span><br><span class="line">190</span><br><span class="line">191</span><br><span class="line">192</span><br><span class="line">193</span><br><span class="line">194</span><br><span class="line">195</span><br><span class="line">196</span><br><span class="line">197</span><br><span class="line">198</span><br><span class="line">199</span><br><span class="line">200</span><br><span class="line">201</span><br><span class="line">202</span><br><span class="line">203</span><br><span class="line">204</span><br><span class="line">205</span><br><span class="line">206</span><br><span class="line">207</span><br><span class="line">208</span><br><span class="line">209</span><br><span class="line">210</span><br><span class="line">211</span><br><span class="line">212</span><br><span class="line">213</span><br><span class="line">214</span><br><span class="line">215</span><br><span class="line">216</span><br><span class="line">217</span><br><span class="line">218</span><br><span class="line">219</span><br><span class="line">220</span><br><span class="line">221</span><br><span class="line">222</span><br><span class="line">223</span><br><span class="line">224</span><br><span class="line">225</span><br><span class="line">226</span><br><span class="line">227</span><br><span class="line">228</span><br><span class="line">229</span><br><span class="line">230</span><br><span class="line">231</span><br><span class="line">232</span><br><span class="line">233</span><br><span class="line">234</span><br><span class="line">235</span><br><span class="line">236</span><br><span class="line">237</span><br><span class="line">238</span><br><span class="line">239</span><br><span class="line">240</span><br><span class="line">241</span><br><span class="line">242</span><br><span class="line">243</span><br><span class="line">244</span><br><span class="line">245</span><br><span class="line">246</span><br><span class="line">247</span><br><span class="line">248</span><br><span class="line">249</span><br><span class="line">250</span><br><span class="line">251</span><br><span class="line">252</span><br><span class="line">253</span><br><span class="line">254</span><br><span class="line">255</span><br><span class="line">256</span><br><span class="line">257</span><br><span class="line">258</span><br><span class="line">259</span><br><span class="line">260</span><br><span class="line">261</span><br><span class="line">262</span><br><span class="line">263</span><br><span class="line">264</span><br><span class="line">265</span><br><span class="line">266</span><br><span class="line">267</span><br><span class="line">268</span><br><span class="line">269</span><br><span class="line">270</span><br><span class="line">271</span><br><span class="line">272</span><br><span class="line">273</span><br><span class="line">274</span><br><span class="line">275</span><br><span class="line">276</span><br><span class="line">277</span><br><span class="line">278</span><br><span class="line">279</span><br><span class="line">280</span><br><span class="line">281</span><br><span class="line">282</span><br><span class="line">283</span><br><span class="line">284</span><br><span class="line">285</span><br><span class="line">286</span><br><span class="line">287</span><br><span class="line">288</span><br><span class="line">289</span><br><span class="line">290</span><br><span class="line">291</span><br><span class="line">292</span><br><span class="line">293</span><br><span class="line">294</span><br><span class="line">295</span><br><span class="line">296</span><br><span class="line">297</span><br><span class="line">298</span><br><span class="line">299</span><br><span class="line">300</span><br><span class="line">301</span><br><span class="line">302</span><br><span class="line">303</span><br><span class="line">304</span><br><span class="line">305</span><br><span class="line">306</span><br><span class="line">307</span><br><span class="line">308</span><br><span class="line">309</span><br><span class="line">310</span><br><span class="line">311</span><br><span class="line">312</span><br><span class="line">313</span><br><span class="line">314</span><br><span class="line">315</span><br><span class="line">316</span><br><span class="line">317</span><br><span class="line">318</span><br><span class="line">319</span><br><span class="line">320</span><br><span class="line">321</span><br><span class="line">322</span><br><span class="line">323</span><br><span class="line">324</span><br><span class="line">325</span><br><span class="line">326</span><br><span class="line">327</span><br><span class="line">328</span><br><span class="line">329</span><br><span class="line">330</span><br><span class="line">331</span><br><span class="line">332</span><br><span class="line">333</span><br><span class="line">334</span><br><span class="line">335</span><br><span class="line">336</span><br><span class="line">337</span><br><span class="line">338</span><br><span class="line">339</span><br><span class="line">340</span><br><span class="line">341</span><br><span class="line">342</span><br><span class="line">343</span><br><span class="line">344</span><br><span class="line">345</span><br><span class="line">346</span><br><span class="line">347</span><br><span class="line">348</span><br><span class="line">349</span><br><span class="line">350</span><br><span class="line">351</span><br><span class="line">352</span><br><span class="line">353</span><br><span class="line">354</span><br><span class="line">355</span><br><span class="line">356</span><br><span class="line">357</span><br><span class="line">358</span><br><span class="line">359</span><br><span class="line">360</span><br><span class="line">361</span><br><span class="line">362</span><br><span class="line">363</span><br><span class="line">364</span><br><span class="line">365</span><br><span class="line">366</span><br><span class="line">367</span><br><span class="line">368</span><br><span class="line">369</span><br><span class="line">370</span><br><span class="line">371</span><br><span class="line">372</span><br><span class="line">373</span><br><span class="line">374</span><br><span class="line">375</span><br><span class="line">376</span><br><span class="line">377</span><br><span class="line">378</span><br><span class="line">379</span><br><span class="line">380</span><br><span class="line">381</span><br><span class="line">382</span><br><span class="line">383</span><br><span class="line">384</span><br><span class="line">385</span><br><span class="line">386</span><br><span class="line">387</span><br><span class="line">388</span><br><span class="line">389</span><br><span class="line">390</span><br><span class="line">391</span><br><span class="line">392</span><br><span class="line">393</span><br><span class="line">394</span><br><span class="line">395</span><br><span class="line">396</span><br><span class="line">397</span><br><span class="line">398</span><br><span class="line">399</span><br><span class="line">400</span><br><span class="line">401</span><br><span class="line">402</span><br><span class="line">403</span><br><span class="line">404</span><br><span class="line">405</span><br><span class="line">406</span><br><span class="line">407</span><br><span class="line">408</span><br><span class="line">409</span><br><span class="line">410</span><br><span class="line">411</span><br><span class="line">412</span><br><span class="line">413</span><br><span class="line">414</span><br><span class="line">415</span><br><span class="line">416</span><br><span class="line">417</span><br><span class="line">418</span><br><span class="line">419</span><br><span class="line">420</span><br><span class="line">421</span><br><span class="line">422</span><br><span class="line">423</span><br><span class="line">424</span><br><span class="line">425</span><br><span class="line">426</span><br><span class="line">427</span><br><span class="line">428</span><br><span class="line">429</span><br><span class="line">430</span><br><span class="line">431</span><br><span class="line">432</span><br><span class="line">433</span><br><span class="line">434</span><br><span class="line">435</span><br><span class="line">436</span><br><span class="line">437</span><br><span class="line">438</span><br><span class="line">439</span><br><span class="line">440</span><br><span class="line">441</span><br><span class="line">442</span><br><span class="line">443</span><br><span class="line">444</span><br><span class="line">445</span><br><span class="line">446</span><br><span class="line">447</span><br><span class="line">448</span><br><span class="line">449</span><br><span class="line">450</span><br><span class="line">451</span><br><span class="line">452</span><br><span class="line">453</span><br><span class="line">454</span><br><span class="line">455</span><br><span class="line">456</span><br><span class="line">457</span><br><span class="line">458</span><br><span class="line">459</span><br><span class="line">460</span><br><span class="line">461</span><br><span class="line">462</span><br><span class="line">463</span><br><span class="line">464</span><br><span class="line">465</span><br><span class="line">466</span><br><span class="line">467</span><br><span class="line">468</span><br><span class="line">469</span><br><span class="line">470</span><br><span class="line">471</span><br><span class="line">472</span><br><span class="line">473</span><br><span class="line">474</span><br><span class="line">475</span><br><span class="line">476</span><br><span class="line">477</span><br><span class="line">478</span><br><span class="line">479</span><br><span class="line">480</span><br><span class="line">481</span><br><span class="line">482</span><br><span class="line">483</span><br><span class="line">484</span><br><span class="line">485</span><br><span class="line">486</span><br><span class="line">487</span><br><span class="line">488</span><br><span class="line">489</span><br><span class="line">490</span><br><span class="line">491</span><br><span class="line">492</span><br><span class="line">493</span><br><span class="line">494</span><br><span class="line">495</span><br><span class="line">496</span><br><span class="line">497</span><br><span class="line">498</span><br><span class="line">499</span><br><span class="line">500</span><br><span class="line">501</span><br><span class="line">502</span><br><span class="line">503</span><br><span class="line">504</span><br><span class="line">505</span><br><span class="line">506</span><br><span class="line">507</span><br><span class="line">508</span><br><span class="line">509</span><br><span class="line">510</span><br><span class="line">511</span><br><span class="line">512</span><br><span class="line">513</span><br><span class="line">514</span><br><span class="line">515</span><br><span class="line">516</span><br><span class="line">517</span><br><span class="line">518</span><br><span class="line">519</span><br><span class="line">520</span><br><span class="line">521</span><br><span class="line">522</span><br><span class="line">523</span><br><span class="line">524</span><br><span class="line">525</span><br><span class="line">526</span><br><span class="line">527</span><br><span class="line">528</span><br><span class="line">529</span><br><span class="line">530</span><br><span class="line">531</span><br><span class="line">532</span><br><span class="line">533</span><br><span class="line">534</span><br><span class="line">535</span><br><span class="line">536</span><br><span class="line">537</span><br><span class="line">538</span><br><span class="line">539</span><br><span class="line">540</span><br><span class="line">541</span><br><span class="line">542</span><br><span class="line">543</span><br><span class="line">544</span><br><span class="line">545</span><br><span class="line">546</span><br><span class="line">547</span><br><span class="line">548</span><br><span class="line">549</span><br><span class="line">550</span><br><span class="line">551</span><br><span class="line">552</span><br><span class="line">553</span><br><span class="line">554</span><br><span class="line">555</span><br><span class="line">556</span><br><span class="line">557</span><br><span class="line">558</span><br><span class="line">559</span><br><span class="line">560</span><br><span class="line">561</span><br><span class="line">562</span><br><span class="line">563</span><br><span class="line">564</span><br><span class="line">565</span><br><span class="line">566</span><br><span class="line">567</span><br><span class="line">568</span><br><span class="line">569</span><br><span class="line">570</span><br><span class="line">571</span><br><span class="line">572</span><br><span class="line">573</span><br><span class="line">574</span><br><span class="line">575</span><br><span class="line">576</span><br><span class="line">577</span><br><span class="line">578</span><br><span class="line">579</span><br><span class="line">580</span><br><span class="line">581</span><br><span class="line">582</span><br><span class="line">583</span><br><span class="line">584</span><br><span class="line">585</span><br><span class="line">586</span><br><span class="line">587</span><br><span class="line">588</span><br><span class="line">589</span><br><span class="line">590</span><br><span class="line">591</span><br><span class="line">592</span><br></pre></td><td class="code"><pre><span class="line">import numpy as np</span><br><span class="line">import datetime</span><br><span class="line">import time</span><br><span class="line">from collections import defaultdict</span><br><span class="line">from . import mask as maskUtils</span><br><span class="line">import copy</span><br><span class="line"> </span><br><span class="line">class COCOeval:</span><br><span class="line">    # Interface for evaluating detection on the Microsoft COCO dataset.</span><br><span class="line">    #</span><br><span class="line">    # The usage for CocoEval is as follows:</span><br><span class="line">    #  cocoGt&#x3D;..., cocoDt&#x3D;...       # load dataset and results</span><br><span class="line">    #  E &#x3D; CocoEval(cocoGt,cocoDt); # initialize CocoEval object</span><br><span class="line">    #  E.params.recThrs &#x3D; ...;      # set parameters as desired</span><br><span class="line">    #  E.evaluate();                # run per image evaluation</span><br><span class="line">    #  E.accumulate();              # accumulate per image results</span><br><span class="line">    #  E.summarize();               # display summary metrics of results</span><br><span class="line">    # For example usage see evalDemo.m and http:&#x2F;&#x2F;mscoco.org&#x2F;.</span><br><span class="line">    #</span><br><span class="line">    # The evaluation parameters are as follows (defaults in brackets):</span><br><span class="line">    #  imgIds     - [all] N img ids to use for evaluation</span><br><span class="line">    #  catIds     - [all] K cat ids to use for evaluation</span><br><span class="line">    #  iouThrs    - [.5:.05:.95] T&#x3D;10 IoU thresholds for evaluation</span><br><span class="line">    #  recThrs    - [0:.01:1] R&#x3D;101 recall thresholds for evaluation</span><br><span class="line">    #  areaRng    - [...] A&#x3D;4 object area ranges for evaluation</span><br><span class="line">    #  maxDets    - [1 10 100] M&#x3D;3 thresholds on max detections per image</span><br><span class="line">    #  iouType    - [&#39;segm&#39;] set iouType to &#39;segm&#39;, &#39;bbox&#39; or &#39;keypoints&#39;</span><br><span class="line">    #  iouType replaced the now DEPRECATED useSegm parameter.</span><br><span class="line">    #  useCats    - [1] if true use category labels for evaluation</span><br><span class="line">    # Note: if useCats&#x3D;0 category labels are ignored as in proposal scoring.</span><br><span class="line">    # Note: multiple areaRngs [Ax2] and maxDets [Mx1] can be specified.</span><br><span class="line">    #</span><br><span class="line">    # evaluate(): evaluates detections on every image and every category and</span><br><span class="line">    # concats the results into the &quot;evalImgs&quot; with fields:</span><br><span class="line">    #  dtIds      - [1xD] id for each of the D detections (dt)</span><br><span class="line">    #  gtIds      - [1xG] id for each of the G ground truths (gt)</span><br><span class="line">    #  dtMatches  - [TxD] matching gt id at each IoU or 0</span><br><span class="line">    #  gtMatches  - [TxG] matching dt id at each IoU or 0</span><br><span class="line">    #  dtScores   - [1xD] confidence of each dt</span><br><span class="line">    #  gtIgnore   - [1xG] ignore flag for each gt</span><br><span class="line">    #  dtIgnore   - [TxD] ignore flag for each dt at each IoU</span><br><span class="line">    #</span><br><span class="line">    # accumulate(): accumulates the per-image, per-category evaluation</span><br><span class="line">    # results in &quot;evalImgs&quot; into the dictionary &quot;eval&quot; with fields:</span><br><span class="line">    #  params     - parameters used for evaluation</span><br><span class="line">    #  date       - date evaluation was performed</span><br><span class="line">    #  counts     - [T,R,K,A,M] parameter dimensions (see above)</span><br><span class="line">    #  precision  - [TxRxKxAxM] precision for every evaluation setting</span><br><span class="line">    #  recall     - [TxKxAxM] max recall for every evaluation setting</span><br><span class="line">    # Note: precision and recall&#x3D;&#x3D;-1 for settings with no gt objects.</span><br><span class="line">    #</span><br><span class="line">    # See also coco, mask, pycocoDemo, pycocoEvalDemo</span><br><span class="line">    #</span><br><span class="line">    # Microsoft COCO Toolbox.      version 2.0</span><br><span class="line">    # Data, paper, and tutorials available at:  http:&#x2F;&#x2F;mscoco.org&#x2F;</span><br><span class="line">    # Code written by Piotr Dollar and Tsung-Yi Lin, 2015.</span><br><span class="line">    # Licensed under the Simplified BSD License [see coco&#x2F;license.txt]</span><br><span class="line">    def __init__(self, cocoGt&#x3D;None, cocoDt&#x3D;None, iouType&#x3D;&#39;segm&#39;):</span><br><span class="line">        &#39;&#39;&#39;</span><br><span class="line">        Initialize CocoEval using coco APIs for gt and dt</span><br><span class="line">        :param cocoGt: coco object with ground truth annotations</span><br><span class="line">        :param cocoDt: coco object with detection results</span><br><span class="line">        :return: None</span><br><span class="line">        &#39;&#39;&#39;</span><br><span class="line">        if not iouType:</span><br><span class="line">            print(&#39;iouType not specified. use default iouType segm&#39;)</span><br><span class="line">        self.cocoGt   &#x3D; cocoGt              # ground truth COCO API</span><br><span class="line">        self.cocoDt   &#x3D; cocoDt              # detections COCO API</span><br><span class="line">        self.evalImgs &#x3D; defaultdict(list)   # per-image per-category evaluation results [KxAxI] elements</span><br><span class="line">        self.eval     &#x3D; &#123;&#125;                  # accumulated evaluation results</span><br><span class="line">        self._gts &#x3D; defaultdict(list)       # gt for evaluation</span><br><span class="line">        self._dts &#x3D; defaultdict(list)       # dt for evaluation</span><br><span class="line">        self.params &#x3D; Params(iouType&#x3D;iouType) # parameters</span><br><span class="line">        self._paramsEval &#x3D; &#123;&#125;               # parameters for evaluation</span><br><span class="line">        self.stats &#x3D; []                     # result summarization</span><br><span class="line">        self.ious &#x3D; &#123;&#125;                      # ious between all gts and dts</span><br><span class="line">        if not cocoGt is None:</span><br><span class="line">            # 把GT中所有的img id 与 类别 id 加入 参数dict中</span><br><span class="line">            self.params.imgIds &#x3D; sorted(cocoGt.getImgIds())</span><br><span class="line">            self.params.catIds &#x3D; sorted(cocoGt.getCatIds())</span><br><span class="line"> </span><br><span class="line"> </span><br><span class="line">    def _prepare(self):</span><br><span class="line">        &#39;&#39;&#39;</span><br><span class="line">        Prepare ._gts and ._dts for evaluation based on params</span><br><span class="line">        在目标检测中 _.gts 索引Ann的index为 【图片ip， 类别ip】，得到的是一个list数组，如果一张图片的一个类别有多个bbox，</span><br><span class="line">        那么list中将会有多个item ._dts同理</span><br><span class="line">        :return: None</span><br><span class="line">        &#39;&#39;&#39;</span><br><span class="line">        def _toMask(anns, coco):</span><br><span class="line">            # modify ann[&#39;segmentation&#39;] by reference</span><br><span class="line">            for ann in anns:</span><br><span class="line">                rle &#x3D; coco.annToRLE(ann)</span><br><span class="line">                ann[&#39;segmentation&#39;] &#x3D; rle</span><br><span class="line">        p &#x3D; self.params</span><br><span class="line">        if p.useCats:</span><br><span class="line">            # 获取特定图片，特定类别的注释，主要是清除检测中出现gt中没有的img id，class id</span><br><span class="line">            gts&#x3D;self.cocoGt.loadAnns(self.cocoGt.getAnnIds(imgIds&#x3D;p.imgIds, catIds&#x3D;p.catIds))</span><br><span class="line">            dts&#x3D;self.cocoDt.loadAnns(self.cocoDt.getAnnIds(imgIds&#x3D;p.imgIds, catIds&#x3D;p.catIds))</span><br><span class="line">        else:</span><br><span class="line">            gts&#x3D;self.cocoGt.loadAnns(self.cocoGt.getAnnIds(imgIds&#x3D;p.imgIds))</span><br><span class="line">            dts&#x3D;self.cocoDt.loadAnns(self.cocoDt.getAnnIds(imgIds&#x3D;p.imgIds))</span><br><span class="line"> </span><br><span class="line">        # convert ground truth to mask if iouType &#x3D;&#x3D; &#39;segm&#39;</span><br><span class="line">        if p.iouType &#x3D;&#x3D; &#39;segm&#39;:</span><br><span class="line">            _toMask(gts, self.cocoGt)</span><br><span class="line">            _toMask(dts, self.cocoDt)</span><br><span class="line">        # set ignore flag</span><br><span class="line">        for gt in gts:</span><br><span class="line">            # 部分比较小的物体，会设置忽略检测 根据json中的注释来定</span><br><span class="line">            gt[&#39;ignore&#39;] &#x3D; gt[&#39;ignore&#39;] if &#39;ignore&#39; in gt else 0</span><br><span class="line">            gt[&#39;ignore&#39;] &#x3D; &#39;iscrowd&#39; in gt and gt[&#39;iscrowd&#39;]</span><br><span class="line">            if p.iouType &#x3D;&#x3D; &#39;keypoints&#39;:</span><br><span class="line">                gt[&#39;ignore&#39;] &#x3D; (gt[&#39;num_keypoints&#39;] &#x3D;&#x3D; 0) or gt[&#39;ignore&#39;]</span><br><span class="line">        self._gts &#x3D; defaultdict(list)       # gt for evaluation</span><br><span class="line">        self._dts &#x3D; defaultdict(list)       # dt for evaluation</span><br><span class="line">        # 给对应img，类别 添加对应的bbox信息</span><br><span class="line">        for gt in gts:</span><br><span class="line">            self._gts[gt[&#39;image_id&#39;], gt[&#39;category_id&#39;]].append(gt)</span><br><span class="line">        for dt in dts:</span><br><span class="line">            self._dts[dt[&#39;image_id&#39;], dt[&#39;category_id&#39;]].append(dt)</span><br><span class="line">        #得到的是每张图片，单个类别的检测结果的集合。</span><br><span class="line">        self.evalImgs &#x3D; defaultdict(list)   # per-image per-category evaluation results</span><br><span class="line">        self.eval     &#x3D; &#123;&#125;                  # accumulated evaluation results</span><br><span class="line"> </span><br><span class="line">    def evaluate(self):</span><br><span class="line">        &#39;&#39;&#39;</span><br><span class="line">        Run per image evaluation on given images and store results (a list of dict) in self.evalImgs</span><br><span class="line">        :return: None</span><br><span class="line">        &#39;&#39;&#39;</span><br><span class="line">        tic &#x3D; time.time()</span><br><span class="line">        print(&#39;Running per image evaluation...&#39;)</span><br><span class="line">        p &#x3D; self.params</span><br><span class="line">        # add backward compatibility if useSegm is specified in params</span><br><span class="line">        if not p.useSegm is None:</span><br><span class="line">            p.iouType &#x3D; &#39;segm&#39; if p.useSegm &#x3D;&#x3D; 1 else &#39;bbox&#39;</span><br><span class="line">            print(&#39;useSegm (deprecated) is not None. Running &#123;&#125; evaluation&#39;.format(p.iouType))</span><br><span class="line">        print(&#39;Evaluate annotation type *&#123;&#125;*&#39;.format(p.iouType))</span><br><span class="line">        # 取出GT中的，img cat id</span><br><span class="line">        p.imgIds &#x3D; list(np.unique(p.imgIds))</span><br><span class="line">        if p.useCats:</span><br><span class="line">            p.catIds &#x3D; list(np.unique(p.catIds))</span><br><span class="line">        p.maxDets &#x3D; sorted(p.maxDets)</span><br><span class="line">        self.params&#x3D;p</span><br><span class="line"> </span><br><span class="line">        self._prepare()</span><br><span class="line">        # loop through images, area range, max detection number</span><br><span class="line">        catIds &#x3D; p.catIds if p.useCats else [-1]</span><br><span class="line"> </span><br><span class="line">        if p.iouType &#x3D;&#x3D; &#39;segm&#39; or p.iouType &#x3D;&#x3D; &#39;bbox&#39;:</span><br><span class="line">            computeIoU &#x3D; self.computeIoU</span><br><span class="line">        elif p.iouType &#x3D;&#x3D; &#39;keypoints&#39;:</span><br><span class="line">            computeIoU &#x3D; self.computeOks</span><br><span class="line">        # ious返回的是一个【M * N】的ndarry， 其中M是在这个img中，catId下有多少个预测的bbox， N是在这个img，catId下有多少个GT</span><br><span class="line">        self.ious &#x3D; &#123;(imgId, catId): computeIoU(imgId, catId) \</span><br><span class="line">                        for imgId in p.imgIds</span><br><span class="line">                        for catId in catIds&#125;</span><br><span class="line"> </span><br><span class="line">        evaluateImg &#x3D; self.evaluateImg</span><br><span class="line">        maxDet &#x3D; p.maxDets[-1]</span><br><span class="line">        # self.evalImages 顺序是 K，A，M，I 一共K*A*M*I个单张图片的检测结果，单张图片的特定类别，特定面积范围，特定最大检测个数下的检测结果。</span><br><span class="line">        #我们可以按照这个来索引对应的检测结果，在后续accumulate函数中有具体使用。</span><br><span class="line">        self.evalImgs &#x3D; [evaluateImg(imgId, catId, areaRng, maxDet)</span><br><span class="line">                 for catId in catIds</span><br><span class="line">                 for areaRng in p.areaRng</span><br><span class="line">                 for imgId in p.imgIds</span><br><span class="line">             ]</span><br><span class="line">        self._paramsEval &#x3D; copy.deepcopy(self.params)</span><br><span class="line">        toc &#x3D; time.time()</span><br><span class="line">        print(&#39;DONE (t&#x3D;&#123;:0.2f&#125;s).&#39;.format(toc-tic))</span><br><span class="line"> </span><br><span class="line">    # 这块用cython写的，主要返回的就是 imgId，catId对应的M*N矩阵，每个值都是对应框的IoU值</span><br><span class="line">    def computeIoU(self, imgId, catId):</span><br><span class="line">        p &#x3D; self.params</span><br><span class="line">        if p.useCats:</span><br><span class="line">            gt &#x3D; self._gts[imgId,catId]</span><br><span class="line">            dt &#x3D; self._dts[imgId,catId]</span><br><span class="line">        else:</span><br><span class="line">            #把这张图片的所有类别的所有检测结果进行一个数组的合并</span><br><span class="line">            gt &#x3D; [_ for cId in p.catIds for _ in self._gts[imgId,cId]]</span><br><span class="line">            dt &#x3D; [_ for cId in p.catIds for _ in self._dts[imgId,cId]]</span><br><span class="line">        if len(gt) &#x3D;&#x3D; 0 and len(dt) &#x3D;&#x3D;0:</span><br><span class="line">            return []</span><br><span class="line">        #按照网络预测的置信度score排序</span><br><span class="line">        inds &#x3D; np.argsort([-d[&#39;score&#39;] for d in dt], kind&#x3D;&#39;mergesort&#39;)</span><br><span class="line">        dt &#x3D; [dt[i] for i in inds]</span><br><span class="line">        #把超出最大检测结果的bbox剔除</span><br><span class="line">        if len(dt) &gt; p.maxDets[-1]:</span><br><span class="line">            dt&#x3D;dt[0:p.maxDets[-1]]</span><br><span class="line"> </span><br><span class="line">        if p.iouType &#x3D;&#x3D; &#39;segm&#39;:</span><br><span class="line">            g &#x3D; [g[&#39;segmentation&#39;] for g in gt]</span><br><span class="line">            d &#x3D; [d[&#39;segmentation&#39;] for d in dt]</span><br><span class="line">        elif p.iouType &#x3D;&#x3D; &#39;bbox&#39;:</span><br><span class="line">            g &#x3D; [g[&#39;bbox&#39;] for g in gt]</span><br><span class="line">            d &#x3D; [d[&#39;bbox&#39;] for d in dt]</span><br><span class="line">        else:</span><br><span class="line">            raise Exception(&#39;unknown iouType for iou computation&#39;)</span><br><span class="line"> </span><br><span class="line">        # compute iou between each dt and gt region</span><br><span class="line">        iscrowd &#x3D; [int(o[&#39;iscrowd&#39;]) for o in gt]</span><br><span class="line">        ious &#x3D; maskUtils.iou(d,g,iscrowd)</span><br><span class="line">        return ious</span><br><span class="line"> </span><br><span class="line">    def computeOks(self, imgId, catId):</span><br><span class="line">        p &#x3D; self.params</span><br><span class="line">        # dimention here should be Nxm</span><br><span class="line">        gts &#x3D; self._gts[imgId, catId]</span><br><span class="line">        dts &#x3D; self._dts[imgId, catId]</span><br><span class="line">        inds &#x3D; np.argsort([-d[&#39;score&#39;] for d in dts], kind&#x3D;&#39;mergesort&#39;)</span><br><span class="line">        dts &#x3D; [dts[i] for i in inds]</span><br><span class="line">        if len(dts) &gt; p.maxDets[-1]:</span><br><span class="line">            dts &#x3D; dts[0:p.maxDets[-1]]</span><br><span class="line">        # if len(gts) &#x3D;&#x3D; 0 and len(dts) &#x3D;&#x3D; 0:</span><br><span class="line">        if len(gts) &#x3D;&#x3D; 0 or len(dts) &#x3D;&#x3D; 0:</span><br><span class="line">            return []</span><br><span class="line">        ious &#x3D; np.zeros((len(dts), len(gts)))</span><br><span class="line">        sigmas &#x3D; p.kpt_oks_sigmas</span><br><span class="line">        vars &#x3D; (sigmas * 2)**2</span><br><span class="line">        k &#x3D; len(sigmas)</span><br><span class="line">        # compute oks between each detection and ground truth object</span><br><span class="line">        for j, gt in enumerate(gts):</span><br><span class="line">            # create bounds for ignore regions(double the gt bbox)</span><br><span class="line">            g &#x3D; np.array(gt[&#39;keypoints&#39;])</span><br><span class="line">            xg &#x3D; g[0::3]; yg &#x3D; g[1::3]; vg &#x3D; g[2::3]</span><br><span class="line">            k1 &#x3D; np.count_nonzero(vg &gt; 0)</span><br><span class="line">            bb &#x3D; gt[&#39;bbox&#39;]</span><br><span class="line">            x0 &#x3D; bb[0] - bb[2]; x1 &#x3D; bb[0] + bb[2] * 2</span><br><span class="line">            y0 &#x3D; bb[1] - bb[3]; y1 &#x3D; bb[1] + bb[3] * 2</span><br><span class="line">            for i, dt in enumerate(dts):</span><br><span class="line">                d &#x3D; np.array(dt[&#39;keypoints&#39;])</span><br><span class="line">                xd &#x3D; d[0::3]; yd &#x3D; d[1::3]</span><br><span class="line">                if k1&gt;0:</span><br><span class="line">                    # measure the per-keypoint distance if keypoints visible</span><br><span class="line">                    dx &#x3D; xd - xg</span><br><span class="line">                    dy &#x3D; yd - yg</span><br><span class="line">                else:</span><br><span class="line">                    # measure minimum distance to keypoints in (x0,y0) &amp; (x1,y1)</span><br><span class="line">                    z &#x3D; np.zeros((k))</span><br><span class="line">                    dx &#x3D; np.max((z, x0-xd),axis&#x3D;0)+np.max((z, xd-x1),axis&#x3D;0)</span><br><span class="line">                    dy &#x3D; np.max((z, y0-yd),axis&#x3D;0)+np.max((z, yd-y1),axis&#x3D;0)</span><br><span class="line">                e &#x3D; (dx**2 + dy**2) &#x2F; vars &#x2F; (gt[&#39;area&#39;]+np.spacing(1)) &#x2F; 2</span><br><span class="line">                if k1 &gt; 0:</span><br><span class="line">                    e&#x3D;e[vg &gt; 0]</span><br><span class="line">                ious[i, j] &#x3D; np.sum(np.exp(-e)) &#x2F; e.shape[0]</span><br><span class="line">        return ious</span><br><span class="line"> </span><br><span class="line">    def evaluateImg(self, imgId, catId, aRng, maxDet):</span><br><span class="line">        &#39;&#39;&#39;</span><br><span class="line">        perform evaluation for single category and image</span><br><span class="line">        计算本张图片，特定类别，特定面积阈值，特定最大检测结果下的result。</span><br><span class="line">        :return: dict (single image results)</span><br><span class="line">        &#39;&#39;&#39;</span><br><span class="line">        p &#x3D; self.params</span><br><span class="line">        if p.useCats:</span><br><span class="line">            # 本张图片特定类别的所有检测结果与GT</span><br><span class="line">            gt &#x3D; self._gts[imgId,catId]</span><br><span class="line">            dt &#x3D; self._dts[imgId,catId]</span><br><span class="line">        else:</span><br><span class="line">            gt &#x3D; [_ for cId in p.catIds for _ in self._gts[imgId,cId]]</span><br><span class="line">            dt &#x3D; [_ for cId in p.catIds for _ in self._dts[imgId,cId]]</span><br><span class="line">        if len(gt) &#x3D;&#x3D; 0 and len(dt) &#x3D;&#x3D;0:</span><br><span class="line">            return None</span><br><span class="line"> </span><br><span class="line">        for g in gt:</span><br><span class="line">            #如果不符合特定面积的阈值，就忽略</span><br><span class="line">            if g[&#39;ignore&#39;] or (g[&#39;area&#39;]&lt;aRng[0] or g[&#39;area&#39;]&gt;aRng[1]):</span><br><span class="line">                g[&#39;_ignore&#39;] &#x3D; 1</span><br><span class="line">            else:</span><br><span class="line">                g[&#39;_ignore&#39;] &#x3D; 0</span><br><span class="line"> </span><br><span class="line">        # sort dt highest score first, sort gt ignore last</span><br><span class="line">        # gtind 前面都是 ignore为0 的gt 后面都是 ignore为1的gt</span><br><span class="line">        gtind &#x3D; np.argsort([g[&#39;_ignore&#39;] for g in gt], kind&#x3D;&#39;mergesort&#39;)</span><br><span class="line">        #挑出满足我们这个特定area阈值下的所有gt</span><br><span class="line">        gt &#x3D; [gt[i] for i in gtind]</span><br><span class="line">        dtind &#x3D; np.argsort([-d[&#39;score&#39;] for d in dt], kind&#x3D;&#39;mergesort&#39;)</span><br><span class="line">        #按照置信度大小挑出满足这个最大检测个数下的所有dt</span><br><span class="line">        dt &#x3D; [dt[i] for i in dtind[0:maxDet]]</span><br><span class="line">        iscrowd &#x3D; [int(o[&#39;iscrowd&#39;]) for o in gt]</span><br><span class="line">        # load computed ious</span><br><span class="line"> </span><br><span class="line">        #得到满足area阈值的gt与所有dt的iou结果 （M * n（gtind））</span><br><span class="line">        ious &#x3D; self.ious[imgId, catId][:, gtind] if len(self.ious[imgId, catId]) &gt; 0 else self.ious[imgId, catId]</span><br><span class="line">        #得到我们需要设置的IoU阈值，超过定义为正样本，不符合则为负样本</span><br><span class="line">        T &#x3D; len(p.iouThrs)</span><br><span class="line">        G &#x3D; len(gt)</span><br><span class="line">        D &#x3D; len(dt)</span><br><span class="line">        #在每个阈值下的Gt是否得到匹配</span><br><span class="line">        gtm  &#x3D; np.zeros((T,G))</span><br><span class="line">        #在每个阈值下的Dt是否得到匹配</span><br><span class="line">        dtm  &#x3D; np.zeros((T,D))</span><br><span class="line">        #所有忽略的gt</span><br><span class="line">        gtIg &#x3D; np.array([g[&#39;_ignore&#39;] for g in gt])</span><br><span class="line">        #所有忽略的dt</span><br><span class="line">        dtIg &#x3D; np.zeros((T,D))</span><br><span class="line"> </span><br><span class="line">        #如果这张图片存在这个类别的gt与dt</span><br><span class="line">        if not len(ious)&#x3D;&#x3D;0:</span><br><span class="line">            for tind, t in enumerate(p.iouThrs): #IoU index， IoU阈值</span><br><span class="line">                #按照置信度大小排序好的前 max_Det个dt</span><br><span class="line">                for dind, d in enumerate(dt):</span><br><span class="line">                    # 如果m&#x3D; -1 代表这个dt没有得到匹配 m代表dt匹配的最好的gt的下标</span><br><span class="line">                    iou &#x3D; min([t,1-1e-10])</span><br><span class="line">                    m   &#x3D; -1</span><br><span class="line">                    for gind, g in enumerate(gt):</span><br><span class="line">                        # 如果这个gt已经被其他置信度更好的dt匹配到了，本轮的dt就不能匹配这个gt了。</span><br><span class="line">                        if gtm[tind,gind]&gt;0 and not iscrowd[gind]:</span><br><span class="line">                            continue</span><br><span class="line">                        # 因为gt已经按照ignore排好序了，前面的为0，于是当我们碰到第一个gt的ignore为1时，判断这个dt是否已经匹配到了</span><br><span class="line">                        #其他的gt，如果m&gt;-1证明并且m对应的gt没有被ignore，就直接结束即可，对应的就是这个dt最好的gt。</span><br><span class="line">                        if m&gt;-1 and gtIg[m]&#x3D;&#x3D;0 and gtIg[gind]&#x3D;&#x3D;1:</span><br><span class="line">                            break</span><br><span class="line">                        # 如果计算dt与gt的iou小于目前最佳的IoU，忽略这个gt</span><br><span class="line">                        if ious[dind,gind] &lt; iou:</span><br><span class="line">                            continue</span><br><span class="line">                        # 超过当前最佳的IoU，更新IoU与m的值</span><br><span class="line">                        iou&#x3D;ious[dind,gind]</span><br><span class="line">                        m&#x3D;gind</span><br><span class="line">                    # 如果这个dt没有对应的gt与其匹配，继续dt的下一个循环</span><br><span class="line">                    if m &#x3D;&#x3D;-1:</span><br><span class="line">                        continue</span><br><span class="line">                    # 把当前dt与第m个gt进行匹配，修改dtm与gtm的值，分别一一对应</span><br><span class="line">                    dtIg[tind,dind] &#x3D; gtIg[m] # 如果这个dt对应的最佳gt本身就是被ignore的，就把这个dt也设置为ignore。</span><br><span class="line">                    dtm[tind,dind]  &#x3D; gt[m][&#39;id&#39;]</span><br><span class="line">                    gtm[tind,m]     &#x3D; d[&#39;id&#39;]</span><br><span class="line">        # set unmatched detections outside of area range to ignore</span><br><span class="line">        a &#x3D; np.array([d[&#39;area&#39;]&lt;aRng[0] or d[&#39;area&#39;]&gt;aRng[1] for d in dt]).reshape((1, len(dt)))</span><br><span class="line">        dtIg &#x3D; np.logical_or(dtIg, np.logical_and(dtm&#x3D;&#x3D;0, np.repeat(a,T,0)))</span><br><span class="line">        # store results for given image and category</span><br><span class="line">        return &#123;</span><br><span class="line">                &#39;image_id&#39;:     imgId,</span><br><span class="line">                &#39;category_id&#39;:  catId,</span><br><span class="line">                &#39;aRng&#39;:         aRng,</span><br><span class="line">                &#39;maxDet&#39;:       maxDet,</span><br><span class="line">                &#39;dtIds&#39;:        [d[&#39;id&#39;] for d in dt],</span><br><span class="line">                &#39;gtIds&#39;:        [g[&#39;id&#39;] for g in gt],</span><br><span class="line">                &#39;dtMatches&#39;:    dtm,</span><br><span class="line">                &#39;gtMatches&#39;:    gtm,</span><br><span class="line">                &#39;dtScores&#39;:     [d[&#39;score&#39;] for d in dt],</span><br><span class="line">                &#39;gtIgnore&#39;:     gtIg,</span><br><span class="line">                &#39;dtIgnore&#39;:     dtIg,</span><br><span class="line">            &#125;</span><br><span class="line"> </span><br><span class="line">    def accumulate(self, p &#x3D; None):</span><br><span class="line">        &#39;&#39;&#39;</span><br><span class="line">        Accumulate per image evaluation results and store the result in self.eval</span><br><span class="line">        :param p: input params for evaluation</span><br><span class="line">        :return: None</span><br><span class="line">        &#39;&#39;&#39;</span><br><span class="line">        print(&#39;Accumulating evaluation results...&#39;)</span><br><span class="line">        tic &#x3D; time.time()</span><br><span class="line">        if not self.evalImgs:</span><br><span class="line">            print(&#39;Please run evaluate() first&#39;)</span><br><span class="line">        # allows input customized parameters</span><br><span class="line">        if p is None:</span><br><span class="line">            p &#x3D; self.params</span><br><span class="line">        p.catIds &#x3D; p.catIds if p.useCats &#x3D;&#x3D; 1 else [-1]</span><br><span class="line">        T           &#x3D; len(p.iouThrs) # 多少个ioU的阈值</span><br><span class="line">        R           &#x3D; len(p.recThrs) #多少个recall的阈值</span><br><span class="line">        K           &#x3D; len(p.catIds) if p.useCats else 1 # 多少个类</span><br><span class="line">        A           &#x3D; len(p.areaRng)  #多少个面积阈值</span><br><span class="line">        M           &#x3D; len(p.maxDets)  #多少个最大检测数</span><br><span class="line">        precision   &#x3D; -np.ones((T,R,K,A,M)) # -1 for the precision of absent categories</span><br><span class="line">        recall      &#x3D; -np.ones((T,K,A,M))</span><br><span class="line">        scores      &#x3D; -np.ones((T,R,K,A,M))</span><br><span class="line"> </span><br><span class="line">        # create dictionary for future indexing</span><br><span class="line">        _pe &#x3D; self._paramsEval</span><br><span class="line">        catIds &#x3D; _pe.catIds if _pe.useCats else [-1]</span><br><span class="line">        setK &#x3D; set(catIds)</span><br><span class="line">        setA &#x3D; set(map(tuple, _pe.areaRng))</span><br><span class="line">        setM &#x3D; set(_pe.maxDets)</span><br><span class="line">        setI &#x3D; set(_pe.imgIds)</span><br><span class="line">        # get inds to evaluate</span><br><span class="line">        k_list &#x3D; [n for n, k in enumerate(p.catIds)  if k in setK] #对应不重复的K的id list 后续同此</span><br><span class="line">        m_list &#x3D; [m for n, m in enumerate(p.maxDets) if m in setM]</span><br><span class="line">        a_list &#x3D; [n for n, a in enumerate(map(lambda x: tuple(x), p.areaRng)) if a in setA]</span><br><span class="line">        i_list &#x3D; [n for n, i in enumerate(p.imgIds)  if i in setI]</span><br><span class="line">        I0 &#x3D; len(_pe.imgIds) #多少个图片</span><br><span class="line">        A0 &#x3D; len(_pe.areaRng) #多少个面积阈值</span><br><span class="line">        # retrieve E at each category, area range, and max number of detections</span><br><span class="line">        # self.evalImgs 索引顺序是 K,A,M,I 所以找到在特定K，A，M下的所有图片，需要按照如下的三维索引</span><br><span class="line">        for k, k0 in enumerate(k_list):</span><br><span class="line">            Nk &#x3D; k0*A0*I0  # 当前K0前面过了多少图片与面积阈值</span><br><span class="line">            for a, a0 in enumerate(a_list):</span><br><span class="line">                Na &#x3D; a0*I0 #在当前K0前面过了多少阈值</span><br><span class="line">                for m, maxDet in enumerate(m_list):</span><br><span class="line">                    #k0，a0下的所有Images</span><br><span class="line">                    E &#x3D; [self.evalImgs[Nk + Na + i] for i in i_list]</span><br><span class="line">                    E &#x3D; [e for e in E if not e is None]</span><br><span class="line">                    if len(E) &#x3D;&#x3D; 0:</span><br><span class="line">                        continue</span><br><span class="line">                    #k0，a0，maxdet下的所有Images的得分</span><br><span class="line">                    dtScores &#x3D; np.concatenate([e[&#39;dtScores&#39;][0:maxDet] for e in E])</span><br><span class="line"> </span><br><span class="line">                    # different sorting method generates slightly different results.</span><br><span class="line">                    # mergesort is used to be consistent as Matlab implementation.</span><br><span class="line">                    # k0，a0，maxdet下所有Images得分从高到底的索引 inds</span><br><span class="line">                    inds &#x3D; np.argsort(-dtScores, kind&#x3D;&#39;mergesort&#39;)</span><br><span class="line">                    #按照得分从高到低排序</span><br><span class="line">                    dtScoresSorted &#x3D; dtScores[inds]</span><br><span class="line">                    # 在当前k0,a0下，每张图片不超过MaxDet的所有det按照ind排序。 dtm[T,sum(Det) in every imges]</span><br><span class="line">                    dtm  &#x3D; np.concatenate([e[&#39;dtMatches&#39;][:,0:maxDet] for e in E], axis&#x3D;1)[:,inds]</span><br><span class="line">                    dtIg &#x3D; np.concatenate([e[&#39;dtIgnore&#39;][:,0:maxDet]  for e in E], axis&#x3D;1)[:,inds]</span><br><span class="line">                    gtIg &#x3D; np.concatenate([e[&#39;gtIgnore&#39;] for e in E])</span><br><span class="line">                    #有多少个正样本</span><br><span class="line">                    npig &#x3D; np.count_nonzero(gtIg&#x3D;&#x3D;0 )</span><br><span class="line">                    if npig &#x3D;&#x3D; 0:</span><br><span class="line">                        continue</span><br><span class="line">                    # 如果dtm对应的匹配gt不为0，且对应的gt没有被忽略，这个dt就是TP tips:[1,0,1,0,1,0]</span><br><span class="line">                    tps &#x3D; np.logical_and(               dtm,  np.logical_not(dtIg) )</span><br><span class="line">                    #dtm对应的gt为0， 并且这个dt也没有被忽略，这个dt就是FP  tips:[0,1,0,1,0,1]</span><br><span class="line">                    fps &#x3D; np.logical_and(np.logical_not(dtm), np.logical_not(dtIg) )</span><br><span class="line"> </span><br><span class="line">                    # 按照行的方式（每个Iou阈值下）进行匹配到的累加 每个index也就是到这个置信度的时候有多少个tp，有多少个fp</span><br><span class="line">                    tp_sum &#x3D; np.cumsum(tps, axis&#x3D;1).astype(dtype&#x3D;np.float)</span><br><span class="line">                    fp_sum &#x3D; np.cumsum(fps, axis&#x3D;1).astype(dtype&#x3D;np.float)</span><br><span class="line">                    for t, (tp, fp) in enumerate(zip(tp_sum, fp_sum)):</span><br><span class="line">                        tp &#x3D; np.array(tp) #得到这个Iou下对应的tp tips:[1,0,2,0,3,0]</span><br><span class="line">                        fp &#x3D; np.array(fp) #得到这个IoU下对应的fp tips:[0,1,0,2,0,3]</span><br><span class="line">                        nd &#x3D; len(tp) #有多少个tp</span><br><span class="line">                        rc &#x3D; tp &#x2F; npig #每个置信度分数下对应的recall 如上述例子 若有3个正样本 则rc&#x3D;[1&#x2F;3,1&#x2F;3,2&#x2F;3,2&#x2F;3,1,1]</span><br><span class="line">                        pr &#x3D; tp &#x2F; (fp+tp+np.spacing(1)) #每个阶段对应的精度</span><br><span class="line">                        q  &#x3D; np.zeros((R,))</span><br><span class="line">                        ss &#x3D; np.zeros((R,))</span><br><span class="line"> </span><br><span class="line">                        if nd:</span><br><span class="line">                            recall[t,k,a,m] &#x3D; rc[-1]</span><br><span class="line">                        else:</span><br><span class="line">                            recall[t,k,a,m] &#x3D; 0</span><br><span class="line"> </span><br><span class="line">                        # numpy is slow without cython optimization for accessing elements</span><br><span class="line">                        # use python array gets significant speed improvement</span><br><span class="line">                        pr &#x3D; pr.tolist(); q &#x3D; q.tolist()</span><br><span class="line"> </span><br><span class="line">                        #当前i下的最大精度</span><br><span class="line">                        for i in range(nd-1, 0, -1):</span><br><span class="line">                            if pr[i] &gt; pr[i-1]:</span><br><span class="line">                                pr[i-1] &#x3D; pr[i]</span><br><span class="line"> </span><br><span class="line">                        #找到每个recall发生变化的时候的index，与p.recThrs一一对应，最接近其的值的index</span><br><span class="line">                        inds &#x3D; np.searchsorted(rc, p.recThrs, side&#x3D;&#39;left&#39;)</span><br><span class="line">                        try:</span><br><span class="line">                            for ri, pi in enumerate(inds):</span><br><span class="line">                                #得到每个recall阈值对应的最大精度，存入q中</span><br><span class="line">                                q[ri] &#x3D; pr[pi]</span><br><span class="line">                                #得到这个recall值下的得分</span><br><span class="line">                                ss[ri] &#x3D; dtScoresSorted[pi]</span><br><span class="line">                        except:</span><br><span class="line">                            pass</span><br><span class="line">                        precision[t,:,k,a,m] &#x3D; np.array(q) # 按照recall的大小存入对应的精度</span><br><span class="line">                        scores[t,:,k,a,m] &#x3D; np.array(ss) #存入对应的分数</span><br><span class="line">        self.eval &#x3D; &#123;</span><br><span class="line">            &#39;params&#39;: p,</span><br><span class="line">            &#39;counts&#39;: [T, R, K, A, M],</span><br><span class="line">            &#39;date&#39;: datetime.datetime.now().strftime(&#39;%Y-%m-%d %H:%M:%S&#39;),</span><br><span class="line">            &#39;precision&#39;: precision,</span><br><span class="line">            &#39;recall&#39;:   recall,</span><br><span class="line">            &#39;scores&#39;: scores,</span><br><span class="line">        &#125;</span><br><span class="line">        toc &#x3D; time.time()</span><br><span class="line">        print(&#39;DONE (t&#x3D;&#123;:0.2f&#125;s).&#39;.format( toc-tic))</span><br><span class="line"> </span><br><span class="line">    def summarize(self):</span><br><span class="line">        &#39;&#39;&#39;</span><br><span class="line">        Compute and display summary metrics for evaluation results.</span><br><span class="line">        Note this functin can *only* be applied on the default parameter setting</span><br><span class="line">        &#39;&#39;&#39;</span><br><span class="line">        def _summarize( ap&#x3D;1, iouThr&#x3D;None, areaRng&#x3D;&#39;all&#39;, maxDets&#x3D;100 ):</span><br><span class="line">            p &#x3D; self.params</span><br><span class="line">            iStr &#x3D; &#39; &#123;:&lt;18&#125; &#123;&#125; @[ IoU&#x3D;&#123;:&lt;9&#125; | area&#x3D;&#123;:&gt;6s&#125; | maxDets&#x3D;&#123;:&gt;3d&#125; ] &#x3D; &#123;:0.3f&#125;&#39;</span><br><span class="line">            titleStr &#x3D; &#39;Average Precision&#39; if ap &#x3D;&#x3D; 1 else &#39;Average Recall&#39;</span><br><span class="line">            typeStr &#x3D; &#39;(AP)&#39; if ap&#x3D;&#x3D;1 else &#39;(AR)&#39;</span><br><span class="line">            iouStr &#x3D; &#39;&#123;:0.2f&#125;:&#123;:0.2f&#125;&#39;.format(p.iouThrs[0], p.iouThrs[-1]) \</span><br><span class="line">                if iouThr is None else &#39;&#123;:0.2f&#125;&#39;.format(iouThr)</span><br><span class="line">            # 如果是&#39;all&#39; 就是所有尺度， 如果不是就是特定的尺度</span><br><span class="line">            aind &#x3D; [i for i, aRng in enumerate(p.areaRngLbl) if aRng &#x3D;&#x3D; areaRng]</span><br><span class="line">            mind &#x3D; [i for i, mDet in enumerate(p.maxDets) if mDet &#x3D;&#x3D; maxDets]</span><br><span class="line">            # 如果是ap，就从precision中得到对应面积阈值、最大检测数下的精度</span><br><span class="line">            if ap &#x3D;&#x3D; 1:</span><br><span class="line">                # dimension of precision: [TxRxKxAxM]</span><br><span class="line">                s &#x3D; self.eval[&#39;precision&#39;]</span><br><span class="line">                # 得到特定IoU下的所有pr</span><br><span class="line">                if iouThr is not None:</span><br><span class="line">                    t &#x3D; np.where(iouThr &#x3D;&#x3D; p.iouThrs)[0]</span><br><span class="line">                    s &#x3D; s[t]</span><br><span class="line">                s &#x3D; s[:,:,:,aind,mind]</span><br><span class="line"> </span><br><span class="line">            # 如果是recall，就取出recall的值</span><br><span class="line">            else:</span><br><span class="line">                # dimension of recall: [TxKxAxM]</span><br><span class="line">                s &#x3D; self.eval[&#39;recall&#39;]</span><br><span class="line">                if iouThr is not None:</span><br><span class="line">                    t &#x3D; np.where(iouThr &#x3D;&#x3D; p.iouThrs)[0]</span><br><span class="line">                    s &#x3D; s[t]</span><br><span class="line">                s &#x3D; s[:,:,aind,mind]</span><br><span class="line">            if len(s[s&gt;-1])&#x3D;&#x3D;0:</span><br><span class="line">                mean_s &#x3D; -1</span><br><span class="line">            #除去-1 其他的计算平均精度</span><br><span class="line">            else:</span><br><span class="line">                mean_s &#x3D; np.mean(s[s&gt;-1])</span><br><span class="line">            print(iStr.format(titleStr, typeStr, iouStr, areaRng, maxDets, mean_s))</span><br><span class="line">            return mean_s</span><br><span class="line">        def _summarizeDets():</span><br><span class="line">            stats &#x3D; np.zeros((12,))</span><br><span class="line">            stats[0] &#x3D; _summarize(1) # all iouThr， 所有recall下，所有面积下， 所有类别，在最大检测数100下的的平均AP</span><br><span class="line">            # [1]:IoU阈值为0.5 所有recall下，所有面积下， 所有类别，在最大检测数100下的的平均AP</span><br><span class="line">            stats[1] &#x3D; _summarize(1, iouThr&#x3D;.5, maxDets&#x3D;self.params.maxDets[2])</span><br><span class="line">            # [2]:IoU阈值为0.75 所有recall下，所有面积下， 所有类别，在最大检测数100下的的平均AP</span><br><span class="line">            stats[2] &#x3D; _summarize(1, iouThr&#x3D;.75, maxDets&#x3D;self.params.maxDets[2])</span><br><span class="line">            #[3]: all iouThr， 所有recall下，small面积下， 所有类别，在最大检测数100下的的平均AP</span><br><span class="line">            stats[3] &#x3D; _summarize(1, areaRng&#x3D;&#39;small&#39;, maxDets&#x3D;self.params.maxDets[2])</span><br><span class="line">            #[4]: all iouThr， 所有recall下，medium面积下， 所有类别，在最大检测数100下的的平均AP</span><br><span class="line">            stats[4] &#x3D; _summarize(1, areaRng&#x3D;&#39;medium&#39;, maxDets&#x3D;self.params.maxDets[2])</span><br><span class="line">            #[5]: all iouThr， 所有recall下，large面积下， 所有类别，在最大检测数100下的的平均AP</span><br><span class="line">            stats[5] &#x3D; _summarize(1, areaRng&#x3D;&#39;large&#39;, maxDets&#x3D;self.params.maxDets[2])</span><br><span class="line">            #[6]: all iouThr，所有面积下， 所有类别，在最大检测数1下的的平均recall</span><br><span class="line">            stats[6] &#x3D; _summarize(0, maxDets&#x3D;self.params.maxDets[0])</span><br><span class="line">            #[7]: all iouThr，所有面积下， 所有类别，在最大检测数10下的的平均recall</span><br><span class="line">            stats[7] &#x3D; _summarize(0, maxDets&#x3D;self.params.maxDets[1])</span><br><span class="line">            # [8]: all iouThr，所有面积下， 所有类别，在最大检测数100下的的平均recall</span><br><span class="line">            stats[8] &#x3D; _summarize(0, maxDets&#x3D;self.params.maxDets[2])</span><br><span class="line">            #[9]: all iouThr，small面积下， 所有类别，在最大检测数100下的的平均recall</span><br><span class="line">            stats[9] &#x3D; _summarize(0, areaRng&#x3D;&#39;small&#39;, maxDets&#x3D;self.params.maxDets[2])</span><br><span class="line">            # [10]: all iouThr，medium面积下， 所有类别，在最大检测数100下的的平均recall</span><br><span class="line">            stats[10] &#x3D; _summarize(0, areaRng&#x3D;&#39;medium&#39;, maxDets&#x3D;self.params.maxDets[2])</span><br><span class="line">            # [11]: all iouThr，large面积下， 所有类别，在最大检测数100下的的平均recall</span><br><span class="line">            stats[11] &#x3D; _summarize(0, areaRng&#x3D;&#39;large&#39;, maxDets&#x3D;self.params.maxDets[2])</span><br><span class="line">            return stats</span><br><span class="line">        def _summarizeKps():</span><br><span class="line">            stats &#x3D; np.zeros((10,))</span><br><span class="line">            stats[0] &#x3D; _summarize(1, maxDets&#x3D;20)</span><br><span class="line">            stats[1] &#x3D; _summarize(1, maxDets&#x3D;20, iouThr&#x3D;.5)</span><br><span class="line">            stats[2] &#x3D; _summarize(1, maxDets&#x3D;20, iouThr&#x3D;.75)</span><br><span class="line">            stats[3] &#x3D; _summarize(1, maxDets&#x3D;20, areaRng&#x3D;&#39;medium&#39;)</span><br><span class="line">            stats[4] &#x3D; _summarize(1, maxDets&#x3D;20, areaRng&#x3D;&#39;large&#39;)</span><br><span class="line">            stats[5] &#x3D; _summarize(0, maxDets&#x3D;20)</span><br><span class="line">            stats[6] &#x3D; _summarize(0, maxDets&#x3D;20, iouThr&#x3D;.5)</span><br><span class="line">            stats[7] &#x3D; _summarize(0, maxDets&#x3D;20, iouThr&#x3D;.75)</span><br><span class="line">            stats[8] &#x3D; _summarize(0, maxDets&#x3D;20, areaRng&#x3D;&#39;medium&#39;)</span><br><span class="line">            stats[9] &#x3D; _summarize(0, maxDets&#x3D;20, areaRng&#x3D;&#39;large&#39;)</span><br><span class="line">            return stats</span><br><span class="line">        if not self.eval:</span><br><span class="line">            raise Exception(&#39;Please run accumulate() first&#39;)</span><br><span class="line">        iouType &#x3D; self.params.iouType</span><br><span class="line">        if iouType &#x3D;&#x3D; &#39;segm&#39; or iouType &#x3D;&#x3D; &#39;bbox&#39;:</span><br><span class="line">            summarize &#x3D; _summarizeDets</span><br><span class="line">        elif iouType &#x3D;&#x3D; &#39;keypoints&#39;:</span><br><span class="line">            summarize &#x3D; _summarizeKps</span><br><span class="line">        self.stats &#x3D; summarize()</span><br><span class="line"> </span><br><span class="line">    def __str__(self):</span><br><span class="line">        self.summarize()</span><br><span class="line"> </span><br><span class="line">class Params:</span><br><span class="line">    &#39;&#39;&#39;</span><br><span class="line">    Params for coco evaluation api</span><br><span class="line">    &#39;&#39;&#39;</span><br><span class="line">    def setDetParams(self):</span><br><span class="line">        self.imgIds &#x3D; []</span><br><span class="line">        self.catIds &#x3D; []</span><br><span class="line">        # np.arange causes trouble.  the data point on arange is slightly larger than the true value</span><br><span class="line">        self.iouThrs &#x3D; np.linspace(.5, 0.95, int(np.round((0.95 - .5) &#x2F; .05)) + 1, endpoint&#x3D;True)</span><br><span class="line">        self.recThrs &#x3D; np.linspace(.0, 1.00, int(np.round((1.00 - .0) &#x2F; .01)) + 1, endpoint&#x3D;True)</span><br><span class="line">        self.maxDets &#x3D; [1, 10, 100]</span><br><span class="line">        self.areaRng &#x3D; [[0 ** 2, 1e5 ** 2], [0 ** 2, 32 ** 2], [32 ** 2, 96 ** 2], [96 ** 2, 1e5 ** 2]]</span><br><span class="line">        self.areaRngLbl &#x3D; [&#39;all&#39;, &#39;small&#39;, &#39;medium&#39;, &#39;large&#39;]</span><br><span class="line">        self.useCats &#x3D; 1</span><br><span class="line"> </span><br><span class="line">    def setKpParams(self):</span><br><span class="line">        self.imgIds &#x3D; []</span><br><span class="line">        self.catIds &#x3D; []</span><br><span class="line">        # np.arange causes trouble.  the data point on arange is slightly larger than the true value</span><br><span class="line">        self.iouThrs &#x3D; np.linspace(.5, 0.95, int(np.round((0.95 - .5) &#x2F; .05)) + 1, endpoint&#x3D;True)</span><br><span class="line">        self.recThrs &#x3D; np.linspace(.0, 1.00, int(np.round((1.00 - .0) &#x2F; .01)) + 1, endpoint&#x3D;True)</span><br><span class="line">        self.maxDets &#x3D; [20]</span><br><span class="line">        self.areaRng &#x3D; [[0 ** 2, 1e5 ** 2], [32 ** 2, 96 ** 2], [96 ** 2, 1e5 ** 2]]</span><br><span class="line">        self.areaRngLbl &#x3D; [&#39;all&#39;, &#39;medium&#39;, &#39;large&#39;]</span><br><span class="line">        self.useCats &#x3D; 1</span><br><span class="line">        self.kpt_oks_sigmas &#x3D; np.array([.26, .25, .25, .35, .35, .79, .79, .72, .72, .62,.62, 1.07, 1.07, .87, .87, .89, .89])&#x2F;10.0</span><br><span class="line"> </span><br><span class="line">    def __init__(self, iouType&#x3D;&#39;segm&#39;):</span><br><span class="line">        if iouType &#x3D;&#x3D; &#39;segm&#39; or iouType &#x3D;&#x3D; &#39;bbox&#39;:</span><br><span class="line">            self.setDetParams()</span><br><span class="line">        elif iouType &#x3D;&#x3D; &#39;keypoints&#39;:</span><br><span class="line">            self.setKpParams()</span><br><span class="line">        else:</span><br><span class="line">            raise Exception(&#39;iouType not supported&#39;)</span><br><span class="line">        self.iouType &#x3D; iouType</span><br><span class="line">        # useSegm is deprecated</span><br><span class="line">        self.useSegm &#x3D; None</span><br></pre></td></tr></table></figure>
<ul>
<li><a href="https://blog.csdn.net/qq_37541097/article/details/112248194" target="_blank" rel="noopener">https://blog.csdn.net/qq_37541097/article/details/112248194</a></li>
</ul>

                
                <hr>
                <!-- Pager -->
                <ul class="pager">
                    
                    <li class="previous">
                        <a href="/2021/07/05/lepeng-linux-Linux修改系统编码/" data-toggle="tooltip" data-placement="top" title="Linux 修改系统编码">&larr; Previous Post</a>
                    </li>
                    
                    
                    <li class="next">
                        <a href="/2021/06/29/lepeng-ml-深度学习常见数据集COCO-Python使用-pycocotools-coco/" data-toggle="tooltip" data-placement="top" title="深度学习常见数据集COCO Python 使用 pycocotools.coco">Next Post &rarr;</a>
                    </li>
                    
                </ul>

                <!-- tip start -->
                

                
                <div class="comment_notes">
                    <p>
                        study well and make progress every day; study well and progress every day; study hard and make progress every day.
                    </p>
                </div>
                
                <!-- tip end -->

                <!-- Music start-->
                
                <!-- Music end -->

                <!-- Sharing -->
                
                <div class="social-share"  data-wechat-qrcode-helper="" align="center"></div>
                <!--  css & js -->
                <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/social-share.js/1.0.16/css/share.min.css">
                <script src="https://cdnjs.cloudflare.com/ajax/libs/social-share.js/1.0.16/js/social-share.min.js"></script>
                
                <!-- Sharing -->

                <!-- gitment start -->
                
                <!-- gitment end -->

                <!-- 来必力City版安装代码 -->
                
                <!-- City版安装代码已完成 -->

                <!-- disqus comment start -->
                
                <!-- disqus comment end -->
            </div>
            
            <!-- Tabe of Content -->
            <!-- Table of Contents -->

    
      
        <aside id="sidebar">
          <div id="toc" class="toc-article">
          <strong class="toc-title">Contents</strong>
          
            
              <ol class="toc-nav"><li class="toc-nav-item toc-nav-level-3"><a class="toc-nav-link" href="#Params类："><span class="toc-nav-number">1.</span> <span class="toc-nav-text">Params类：</span></a></li><li class="toc-nav-item toc-nav-level-3"><a class="toc-nav-link" href="#COCOeval类："><span class="toc-nav-number">2.</span> <span class="toc-nav-text">COCOeval类：</span></a></li><li class="toc-nav-item toc-nav-level-3"><a class="toc-nav-link" href="#一个整体的流程："><span class="toc-nav-number">3.</span> <span class="toc-nav-text">一个整体的流程：</span></a></li></ol></li><li class="toc-nav-item toc-nav-level-2"><a class="toc-nav-link" href="#调用"><span class="toc-nav-number"></span> <span class="toc-nav-text">调用</span></a><ol class="toc-nav-child"><li class="toc-nav-item toc-nav-level-3"><a class="toc-nav-link" href="#方式一，计算map"><span class="toc-nav-number">1.</span> <span class="toc-nav-text">方式一，计算map</span></a></li><li class="toc-nav-item toc-nav-level-3"><a class="toc-nav-link" href="#方式一，计算-precision"><span class="toc-nav-number">2.</span> <span class="toc-nav-text">方式一，计算 precision</span></a></li><li class="toc-nav-item toc-nav-level-3"><a class="toc-nav-link" href="#源码加注释"><span class="toc-nav-number">3.</span> <span class="toc-nav-text">源码加注释</span></a></li></ol>
            
          
          </div>
        </aside>
      
    

                
            <!-- Sidebar Container -->
            <div class="
                col-lg-8 col-lg-offset-2
                col-md-10 col-md-offset-1
                sidebar-container">

                <!-- Featured Tags -->
                
                <section>
                    <!-- no hr -->
                    <h5><a href="/tags/">FEATURED TAGS</a></h5>
                    <div class="tags">
                       
                          <a class="tag" href="/tags/#Python" title="Python">Python</a>
                        
                          <a class="tag" href="/tags/#深度学习" title="深度学习">深度学习</a>
                        
                    </div>
                </section>
                

                <!-- Friends Blog -->
                
                <hr>
                <h5>FRIENDS</h5>
                <ul class="list-inline">

                    
                        <li><a href="https://blog.csdn.net/fenglepeng" target="_blank">Feng Lepeng&#39;s CSDN</a></li>
                    
                </ul>
                
            </div>
        </div>
    </div>
</article>




<!-- async load function -->
<script>
    function async(u, c) {
      var d = document, t = 'script',
          o = d.createElement(t),
          s = d.getElementsByTagName(t)[0];
      o.src = u;
      if (c) { o.addEventListener('load', function (e) { c(null, e); }, false); }
      s.parentNode.insertBefore(o, s);
    }
</script>
<!-- anchor-js, Doc:http://bryanbraun.github.io/anchorjs/ -->
<script>
    async("https://cdn.bootcss.com/anchor-js/1.1.1/anchor.min.js",function(){
        anchors.options = {
          visible: 'hover',
          placement: 'left',
          icon: 'ℬ'
        };
        anchors.add().remove('.intro-header h1').remove('.subheading').remove('.sidebar-container h5');
    })
</script>


<style  type="text/css">
    /* place left on bigger screen */
    @media all and (min-width: 800px) {
        .anchorjs-link{
            position: absolute;
            left: -0.75em;
            font-size: 1.1em;
            margin-top : -0.1em;
        }
    }
</style>



    <!-- Footer -->
    <!-- Footer -->
<footer>
    <div class="container">
        <div class="row">
            <div class="col-lg-8 col-lg-offset-2 col-md-10 col-md-offset-1">
                <ul class="list-inline text-center">

                

                

                

                

                

                

                

                </ul>
                <p class="copyright text-muted">
                    Copyright &copy;
                    <a href="https://beian.miit.gov.cn/" target="_blank" rel="noopener">京ICP备18055501号-2</a>;
                    Feng Lepeng 2021
                    <br>
                    Powered by 
                    <a href="https://github.com/dusign/hexo-theme-snail" target="_blank" rel="noopener">
                        <i>hexo-theme-snail</i>
                    </a> | 
                    <iframe name="star" style="margin-left: 2px; margin-bottom:-5px;" frameborder="0" scrolling="0"
                        width="100px" height="20px"
                        src="https://ghbtns.com/github-btn.html?user=flepeng&repo=hexo-theme-lp&type=star">
                    </iframe>
                </p>
            </div>
        </div>
    </div>

</footer>

<!-- jQuery -->

<script src="/js/jquery.min.js"></script>


<!-- Bootstrap Core JavaScript -->

<script src="/js/bootstrap.min.js"></script>


<!-- Custom Theme JavaScript -->

<script src="/js/hux-blog.min.js"></script>


<!-- Search -->

<script src="/js/search.js"></script>


<!-- async load function -->
<script>
    function async(u, c) {
      var d = document, t = 'script',
          o = d.createElement(t),
          s = d.getElementsByTagName(t)[0];
      o.src = u;
      if (c) { o.addEventListener('load', function (e) { c(null, e); }, false); }
      s.parentNode.insertBefore(o, s);
    }
</script>


<!-- jquery.tagcloud.js -->
<script>
    // only load tagcloud.js in tag.html
    if($('#tag_cloud').length !== 0){
        async("https://flepeng.github.io/js/jquery.tagcloud.js",function(){
            $.fn.tagcloud.defaults = {
                //size: {start: 1, end: 1, unit: 'em'},
                color: {start: '#bbbbee', end: '#0085a1'},
            };
            $('#tag_cloud a').tagcloud();
        })
    }
</script>

<!--fastClick.js -->
<script>
    async("https://cdn.bootcss.com/fastclick/1.0.6/fastclick.min.js", function(){
        var $nav = document.querySelector("nav");
        if($nav) FastClick.attach($nav);
    })
</script>


<!-- Google Analytics -->


<script>
    // dynamic User by Hux
    var _gaId = 'UA-XXXXXXXX-X';
    var _gaDomain = 'yoursite';

    // Originial
    (function(i,s,o,g,r,a,m){i['GoogleAnalyticsObject']=r;i[r]=i[r]||function(){
    (i[r].q=i[r].q||[]).push(arguments)},i[r].l=1*new Date();a=s.createElement(o),
    m=s.getElementsByTagName(o)[0];a.async=1;a.src=g;m.parentNode.insertBefore(a,m)
    })(window,document,'script','//www.google-analytics.com/analytics.js','ga');

    ga('create', _gaId, _gaDomain);
    ga('send', 'pageview');
</script>




<!-- Baidu Tongji -->


<!-- Search -->

    <script type="text/javascript">      
        var search_path = "search.xml";
        if (search_path.length == 0) {
            search_path = "search.xml";
        }
    var path = "/" + search_path;
    searchFunc(path, 'local-search-input', 'local-search-result');
    </script>


<!-- busuanzi -->
<script async src="//busuanzi.ibruce.info/busuanzi/2.3/busuanzi.pure.mini.js"></script>






	<a id="rocket" href="#top" class=""></a>
	<script type="text/javascript" src="/js/totop.js?v=1.0.0" async=""></script>
    <script type="text/javascript" src="/js/toc.js?v=1.0.0" async=""></script>

    
        <!-- background effects line -->
        

        
            <script type="text/javascript" src="/js/mouse-click.js" content='[&#34;🌱&#34;,&#34;just do it&#34;,&#34;🍀&#34;]' color='[&#34;rgb(121,93,179)&#34; ,&#34;rgb(76,180,231)&#34; ,&#34;rgb(184,90,154)&#34;]'></script>
        

        <!-- background effects end -->
    

    <!--<script size="50" alpha='0.3' zIndex="-999" src="/js/ribbonStatic.js"></script>-->
    
        <script src="/js/ribbonDynamic.js"></script>
    
</body>

</html>
